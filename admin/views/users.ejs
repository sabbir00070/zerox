<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Users - Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: 'Poppins', sans-serif; }
input[type="checkbox"] {
  appearance: none;
  background-color: #4b5563;
  border-radius: 0.375rem;
  width: 1.25rem;
  height: 1.25rem;
  position: relative;
}
input[type="checkbox"]:checked {
  background-color: #10b981;
}
input[type="checkbox"]:checked::after {
  content: '✔';
  color: white;
  font-size: 0.75rem;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
</style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-6">

<div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
  <div class="bg-gray-800 p-5 rounded-2xl text-center">
    <p class="text-gray-400 text-sm">Total Users</p>
    <h2 class="text-3xl font-bold text-white" id="statTotal">0</h2>
  </div>
  <div class="bg-gray-800 p-5 rounded-2xl text-center">
    <p class="text-gray-400 text-sm">Premium Users</p>
    <h2 class="text-3xl font-bold text-green-400" id="statPremium">0</h2>
  </div>
  <div class="bg-gray-800 p-5 rounded-2xl text-center">
    <p class="text-gray-400 text-sm">Banned Users</p>
    <h2 class="text-3xl font-bold text-red-400" id="statBanned">0</h2>
  </div>
  <div class="bg-gray-800 p-5 rounded-2xl text-center">
    <p class="text-gray-400 text-sm">Total Bombs</p>
    <h2 class="text-3xl font-bold text-indigo-400" id="statBombs">0</h2>
  </div>
</div>

<div class="mb-6 bg-gray-800 rounded-2xl p-4 grid grid-cols-1 sm:grid-cols-4 gap-4">
  <input id="searchChatId" placeholder="Search Chat ID" class="p-3 rounded-xl bg-gray-900 border border-gray-700">
  <select id="filterPremium" class="p-3 rounded-xl bg-gray-900 border border-gray-700">
    <option value="all">All Users</option>
    <option value="premium">Premium</option>
    <option value="free">Free</option>
  </select>
  <select id="filterBanned" class="p-3 rounded-xl bg-gray-900 border border-gray-700">
    <option value="all">All Status</option>
    <option value="banned">Banned</option>
    <option value="active">Active</option>
  </select>
  <div class="flex gap-2">
    <button onclick="exportCSV()" class="flex-1 bg-green-600 rounded-xl py-2">CSV</button>
    <button onclick="exportPDF()" class="flex-1 bg-red-600 rounded-xl py-2">PDF</button>
  </div>
</div>
<div class="overflow-x-auto bg-gray-800 rounded-2xl p-4">
<table id="usersName" class="min-w-full text-sm">
<thead class="bg-gray-700">
<tr>
<th class="p-3">Chat ID</th>
<th class="p-3">Coins</th>
<th class="p-3">Premium</th>
<th class="p-3">Banned</th>
<th class="p-3">Bombs</th>
<th class="p-3">Referrer</th>
<th class="p-3">Register Date</th>
<th class="p-3">Action</th>
</tr>
</thead>
<tbody id="usersTable">
<% users.forEach(user => { %>
<tr class="border-t border-gray-700">
<td class="p-3 chat"><%= user.chat_id %></td>
<td class="p-3"><%= user.coin %></td>
<td class="p-3 premium"><input type="checkbox" <%= user.isPremium ? 'checked' : '' %> disabled></td>
<td class="p-3 banned"><input type="checkbox" <%= user.banned ? 'checked' : '' %> disabled></td>
<td class="p-3 bombs"><%= user.total_bom || 0 %></td>
<td class="p-3"><%= user.rafer || '-' %></td>
<td class="p-3"><%= user.register_date ? new Date(user.register_date).toLocaleDateString() : '-' %></td>
<td class="p-3"><a href="/admin/users/<%= user._id %>" class="bg-indigo-600 px-3 py-1 rounded-lg">Edit</a></td>
</tr>
<% }) %>
</tbody>
</table>
</div>

<div class="flex justify-center gap-3 mt-6">
<button onclick="prevPage()" class="px-4 py-2 bg-gray-700 rounded-lg">Prev</button>
<span id="pageInfo" class="px-4 py-2"></span>
<button onclick="nextPage()" class="px-4 py-2 bg-gray-700 rounded-lg">Next</button>
</div>

<script>
let rows = [...document.querySelectorAll("#usersTable tr")]
let filteredRows = [...rows]
let page = 1
const perPage = 10

const searchInput = document.getElementById("searchChatId")
const filterPremium = document.getElementById("filterPremium")
const filterBanned = document.getElementById("filterBanned")

function applyFilters() {
  const search = searchInput.value.trim().toLowerCase()
  const premium = filterPremium.value
  const banned = filterBanned.value

  filteredRows = rows.filter(row => {
    const chat = row.querySelector(".chat").innerText.toLowerCase()
    const isPremium = row.querySelector(".premium input").checked
    const isBanned = row.querySelector(".banned input").checked

    if (search && !chat.includes(search)) return false
    if (premium === "premium" && !isPremium) return false
    if (premium === "free" && isPremium) return false
    if (banned === "banned" && !isBanned) return false
    if (banned === "active" && isBanned) return false

    return true
  })

  page = 1
  updateStats()
  render()
}

function render() {
  rows.forEach(r => r.style.display = "none")
  filteredRows
    .slice((page - 1) * perPage, page * perPage)
    .forEach(r => r.style.display = "")
  document.getElementById("pageInfo").innerText = `Page ${page}`
}

function nextPage() {
  if (page * perPage < filteredRows.length) {
    page++
    render()
  }
}

function prevPage() {
  if (page > 1) {
    page--
    render()
  }
}

function updateStats() {
  document.getElementById("statTotal").innerText = filteredRows.length
  document.getElementById("statPremium").innerText = filteredRows.filter(r=>r.querySelector(".premium input").checked).length
  document.getElementById("statBanned").innerText = filteredRows.filter(r=>r.querySelector(".banned input").checked).length
  document.getElementById("statBombs").innerText = filteredRows.reduce((a,r)=>a+Number(r.querySelector(".bombs").innerText),0)
}

searchInput.addEventListener("input", applyFilters)
filterPremium.addEventListener("change", applyFilters)
filterBanned.addEventListener("change", applyFilters)

updateStats()
render()

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("l", "pt", "a4");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  pdf.setFillColor(17, 24, 39); // gray-900
  pdf.rect(0, 0, pageWidth, 60, "F");

  pdf.setTextColor(255);
  pdf.setFontSize(18);
  pdf.text("ADMIN USER REPORT", 40, 38);

  pdf.setFontSize(10);
  pdf.text(
    `Generated: ${new Date().toLocaleString()}`,
    pageWidth - 200,
    38
  );
  const head = [
    ["Chat ID", "Coins", "Premium", "Banned", "Bombs", "Referrer", "Register"]
  ];

  const body = filteredRows.map(row => [
    row.querySelector(".chat").innerText,
    row.children[1].innerText,
    row.querySelector(".premium input").checked ? "YES" : "NO",
    row.querySelector(".banned input").checked ? "YES" : "NO",
    row.querySelector(".bombs").innerText,
    row.children[5].innerText,
    row.children[6].innerText,
  ]);
  pdf.autoTable({
    head,
    body,
    startY: 80,
    theme: "grid",
    headStyles: {
      fillColor: [55, 65, 81],
      textColor: 255,
      fontSize: 10
    },
    bodyStyles: {
      fontSize: 9,
      textColor: 50
    },
    styles: {
      halign: "center"
    },
    didDrawPage: function (data) {
      pdf.setFontSize(9);
      pdf.setTextColor(150);
      pdf.text(
        `Page ${pdf.internal.getNumberOfPages()}`,
        pageWidth / 2,
        pageHeight - 20,
        { align: "center" }
      );

      pdf.text(
        "Generated by Admin Panel",
        40,
        pageHeight - 20
      );
    }
  });

  pdf.save("users-report.pdf");
}
function exportCSV() {
  if (filteredRows.length === 0) {
    alert("কোনো ডাটা পাওয়া যায়নি");
    return;
  }

  let csv = [];

  // Bangla Headers
  csv.push([
    "চ্যাট আইডি",
    "কয়েন",
    "প্রিমিয়াম",
    "ব্যান",
    "মোট বোম্ব",
    "রেফার",
    "রেজিস্টার তারিখ"
  ].join(","));

  // Rows
  filteredRows.forEach(row => {
    const chat = row.querySelector(".chat")?.innerText || "";
    const coins = row.children[1]?.innerText || "";
    const premium = row.querySelector(".premium input")?.checked ? "হ্যাঁ" : "না";
    const banned = row.querySelector(".banned input")?.checked ? "হ্যাঁ" : "না";
    const bombs = row.querySelector(".bombs")?.innerText || "";
    const ref = row.children[5]?.innerText || "";
    const date = row.children[6]?.innerText || "";

    csv.push([
      chat,
      coins,
      premium,
      banned,
      bombs,
      ref,
      date
    ].join(","));
  });

  // File name with date
  const today = new Date().toISOString().slice(0, 10);
  const filename = `users_${today}.csv`;

  // Download
  const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>

</body>
</html>